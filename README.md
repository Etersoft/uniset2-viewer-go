# uniset2-viewer-go

Веб-сервер для мониторинга состояния uniset2 процессов, отслеживания изменений внутренних переменных во времени с отображением графиков.

## Возможности

- Получение списка доступных uniset2 объектов
- Просмотр внутренних переменных объекта в реальном времени
- Графики для аналоговых и дискретных величин (Chart.js)
- Хранение истории: in-memory или SQLite
- Единый исполняемый файл (веб-ресурсы встроены через go:embed)
- Расширяемая система рендереров — разный интерфейс для разных типов объектов
- Collapsible секции (графики, IO, переменные, статистика и др.)
- Сохранение настроек UI в localStorage
- **LogServer клиент** — просмотр логов процесса в реальном времени
- **SSE (Server-Sent Events)** — получение обновлений данных без polling

## Установка

```bash
go build -o uniset2-viewer ./cmd/server
```

## Запуск

```bash
./uniset2-viewer [опции]
```

### Параметры

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `--uniset-url` | `http://localhost:8080` | Адрес uniset2 HTTP API |
| `--port` | `8000` | Порт веб-сервера |
| `--poll-interval` | `5s` | Интервал опроса uniset2 |
| `--storage` | `memory` | Тип хранилища: `memory` или `sqlite` |
| `--sqlite-path` | `./history.db` | Путь к SQLite базе данных |
| `--history-ttl` | `1h` | Время хранения истории |
| `--log-format` | `text` | Формат логов: `text` или `json` |
| `--log-level` | `info` | Уровень логирования: `debug`, `info`, `warn`, `error` |
| `--uniset-config` | - | Путь к XML конфигурации UniSet2 (для имён датчиков) |

### Примеры

```bash
# Базовый запуск
./uniset2-viewer --uniset-url http://192.168.1.100:8080

# С SQLite хранилищем
./uniset2-viewer --uniset-url http://192.168.1.100:8080 --storage sqlite --sqlite-path /var/lib/uniset-viewer/history.db

# С кастомным интервалом опроса
./uniset2-viewer --uniset-url http://192.168.1.100:8080 --poll-interval 2s
```

## Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                      Browser (HTML/JS)                      │
│  ┌──────────────┐  ┌──────────────────────────────────────┐ │
│  │ Список       │  │ Вкладка объекта                      │ │
│  │ объектов     │  │ - таблица переменных                 │ │
│  │              │  │ - графики Chart.js                   │ │
│  └──────────────┘  └──────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 uniset2-viewer-go (Go Server)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ HTTP Server │  │ UniSet      │  │ Storage             │  │
│  │ (REST API)  │  │ Client      │  │ (memory/sqlite)     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  UniSet2 процессы (HTTP API)                │
│   /api/v2/list          - список объектов                   │
│   /api/v2/{Object}      - данные объекта                    │
│   /api/v2/{Object}/help - доступные команды                 │
└─────────────────────────────────────────────────────────────┘
```

## Структура проекта

```
uniset2-viewer-go/
├── cmd/server/main.go       # точка входа
├── internal/
│   ├── config/              # конфигурация
│   ├── uniset/              # HTTP клиент к uniset2
│   ├── storage/             # хранилище истории
│   ├── poller/              # периодический опрос
│   ├── api/                 # REST API сервера + SSE
│   ├── logger/              # structured logging (slog)
│   ├── logserver/           # TCP клиент к LogServer UniSet2
│   └── sensorconfig/        # парсер XML конфигурации датчиков
├── ui/
│   ├── embed.go             # go:embed директивы
│   ├── static/              # JS, CSS
│   └── templates/           # HTML шаблоны
├── tests/                   # Playwright e2e тесты
├── go.mod
└── README.md
```

## LogServer

Для объектов с включённым LogServer (указан host и port в ответе API) доступен просмотр логов в реальном времени:

- Подключение через кнопку "Подключить" в секции "Логи"
- Выбор уровня логов (По умолчанию, CRIT, WARN+, INFO+, DEBUG+, ALL)
- Фильтрация по regexp
- Изменяемый размер окна (перетаскивание за нижнюю границу)
- Сворачивание секции

**Важно:** При выборе "По умолчанию" используются уровни логов, установленные в процессе. Для получения логов может потребоваться выбрать конкретный уровень.

## Лицензия

MIT
