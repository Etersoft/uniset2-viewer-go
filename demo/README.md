# Demo Mode - Diesel Generator Simulator

Демонстрационный режим с реалистичной симуляцией двух дизель-генераторов (ДГУ).

## Быстрый старт

```bash
make demo
```

Панель доступна на http://localhost:8001

Выберите **Dashboard → Diesel Generator Control**

## Архитектура

```
demo/mock-server/
├── server.js      # HTTP API + SSE (стандартный UniSet2 API)
├── generators.js  # Симуляция генераторов + ScenarioManager
└── sensors.js     # IONC хранилище датчиков
```

## Датчики (24 шт)

| Датчик | Тип | Диапазон | Описание |
|--------|-----|----------|----------|
| `DGx_Running` | DI | 0/1 | Генератор работает |
| `DGx_Ready` | DI | 0/1 | Готов к запуску |
| `DGx_Alarm` | DI | 0/1 | Аварийный сигнал |
| `DGx_Remote` | DI | 0/1 | Дистанционное управление |
| `DGx_RPM` | AI | 0-2000 | Обороты двигателя |
| `DGx_CoolantTemp` | AI | 0-120 | Температура охлаждающей жидкости, °C |
| `DGx_OilPressure` | AI | 0-10 | Давление масла, bar |
| `DGx_Voltage` | AI | 0-400 | Напряжение, V |
| `DGx_Frequency` | AI | 0-60 | Частота, Hz |
| `DGx_FuelLevel` | AI | 0-100 | Уровень топлива, % |
| `DGx_Power` | AI | 0-500 | Мощность, kW |
| `DGx_Load` | AI | 0-100 | Нагрузка, % |

где `x` = 1 или 2 (номер генератора)

---

## Демо-сценарий

Автоматический цикличный сценарий демонстрирует типичные режимы работы ДГУ.

### Полный цикл (~5 минут)

```
Время     Фаза                         DG1          DG2
───────────────────────────────────────────────────────────────
0:00      ФАЗА 1: Ожидание             READY        STOPPED
0:15      ФАЗА 2: Запуск DG1           STARTING     STOPPED
0:20      ФАЗА 3: Рост нагрузки        30%→85%      STOPPED
1:20      ФАЗА 4: Запуск резерва       85%          STARTING
1:25      ФАЗА 5: Распределение        45%          40%
1:55      ФАЗА 6: Снижение нагрузки    25%→15%      25%→15%
2:25      ФАЗА 7: Останов резерва      30%          STOPPING
2:30      ФАЗА 8: Работа DG1           30%→50%      STOPPED
3:00      ФАЗА 9: Рост нагрузки        50%→85%      STOPPED
3:30      ФАЗА 10: Снова резерв        85%          STARTING
          ... (повторение фаз 5-10) ...
4:30      ФАЗА 11: Смена основного     STOPPING     принимает нагрузку
5:00      Цикл повторяется с DG2 как основным
───────────────────────────────────────────────────────────────
```

### Описание фаз

#### ФАЗА 1: Ожидание (15 сек)
- DG1 в состоянии READY (готов к запуску)
- DG2 остановлен
- Имитация ожидания команды на пуск

#### ФАЗА 2: Запуск DG1 (5 сек)
- RPM плавно растёт 0 → 1500
- Давление масла нарастает
- Напряжение и частота появляются при RPM > 1000

#### ФАЗА 3: Рост нагрузки (60 сек)
- Нагрузка плавно растёт 30% → 85%
- Температура следует за нагрузкой (тепловая инерция)
- Расход топлива пропорционален мощности

#### ФАЗА 4: Запуск резерва (5 сек)
- При достижении 85% нагрузки → сигнал на запуск DG2
- DG2 переходит из READY в STARTING
- Запуск аналогичен фазе 2

#### ФАЗА 5: Распределение нагрузки (30 сек)
- Нагрузка перераспределяется между генераторами
- DG1: 85% → 45%
- DG2: 0% → 40%
- Суммарная нагрузка ~85%

#### ФАЗА 6: Снижение нагрузки (30 сек)
- Общая нагрузка падает (имитация снижения потребления)
- DG1: 45% → 15%
- DG2: 40% → 15%

#### ФАЗА 7: Останов резерва (5 сек)
- При низкой нагрузке DG2 отключается
- DG2: RUNNING → STOPPING → STOPPED
- RPM плавно падает до 0

#### ФАЗА 8-10: Цикл нагрузки
- DG1 работает один
- Нагрузка снова растёт до 85%
- При 85% опять запускается DG2
- Цикл повторяется

#### ФАЗА 11: Смена основного (опционально, каждый 2-й цикл)
- DG1 останавливается (имитация планового ТО)
- DG2 становится основным
- Весь цикл повторяется с DG2

### Аварийный сценарий (каждый 3-й цикл)

```
Время     Событие
──────────────────────────────────────────
0:00      Нормальная работа DG1
0:30      Температура растёт выше нормы
0:45      Перегрев! DG1_Alarm = 1
0:46      Автоматический запуск DG2
0:50      DG2 принимает нагрузку
1:00      Сброс аварии DG1
1:05      DG1 возвращается в READY
          Продолжение нормального цикла
──────────────────────────────────────────
```

---

## Физическая модель

### Взаимозависимости параметров

```
Нагрузка (Load)
    │
    ├──► Мощность: Power = Load × 500 kW
    │
    ├──► Температура: медленно следует за нагрузкой
    │    targetTemp = 75°C + (Load × 0.35)
    │    Тепловая инерция: temp += (target - temp) × 0.02
    │
    └──► Расход топлива: FuelLevel -= Power/500 × 0.0001/сек

RPM (обороты)
    │
    ├──► Давление масла: OilPressure = (RPM/1500) × 4 bar
    │
    └──► Электрика (при RPM > 1000):
         Voltage = 380V, Frequency = 50Hz
```

### Условия аварий

| Авария | Условие | Действие |
|--------|---------|----------|
| Перегрев | Temp > 115°C | ALARM, останов |
| Низкое давление | OilPressure < 1.5 bar при работе | ALARM, останов |
| Превышение оборотов | RPM > 1800 | ALARM, останов |

---

## API управления

### Статус генераторов
```bash
curl http://localhost:9494/demo/status
```

### Управление
```bash
# Запустить генератор
curl "http://localhost:9494/demo/control?action=start&gen=dg1"
curl "http://localhost:9494/demo/control?action=start&gen=dg2"

# Остановить
curl "http://localhost:9494/demo/control?action=stop&gen=dg1"

# Установить нагрузку
curl "http://localhost:9494/demo/control?action=setload&gen=dg1&load=75"

# Симулировать аварию
curl "http://localhost:9494/demo/control?action=alarm&gen=dg1"

# Сбросить аварию
curl "http://localhost:9494/demo/control?action=clear&gen=dg1"
```

### Управление сценарием
```bash
# Статус сценария
curl http://localhost:9494/demo/scenario

# Пауза/продолжение
curl "http://localhost:9494/demo/scenario?action=pause"
curl "http://localhost:9494/demo/scenario?action=resume"

# Перейти к следующей фазе
curl "http://localhost:9494/demo/scenario?action=next"

# Перезапустить сценарий
curl "http://localhost:9494/demo/scenario?action=restart"
```

---

## Docker

### Сервисы

| Сервис | Порт | Описание |
|--------|------|----------|
| demo-mock-server | 9393 (internal) | Симулятор UniSet2 |
| demo-viewer | 8001 | Web-панель |

### Команды

```bash
# Запуск demo режима
make demo

# Или напрямую через docker-compose
docker compose --profile demo up --build

# Остановка
docker compose --profile demo down

# Логи симулятора
docker compose --profile demo logs -f demo-mock-server
```

---

## Расширение

### Добавление новых датчиков

1. Добавить в `sensors.js`:
```javascript
{ id: 25, name: 'DG1_NewSensor', type: 'AI', defaultValue: 0 },
```

2. Обновить `generators.js`:
```javascript
this.newSensor = 0;
// В _syncToSensors():
sensors.setSensor(`${this.id}_NewSensor`, Math.round(this.newSensor));
```

3. Добавить виджет в dashboard `diesel-generator.json`

### Создание нового сценария

Отредактируйте `SCENARIO_PHASES` в `generators.js`:
```javascript
const SCENARIO_PHASES = [
    { name: 'MY_PHASE', duration: 30000, action: (dg1, dg2) => {
        // Ваша логика
    }},
    // ...
];
```
