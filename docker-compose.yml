version: '3.8'

services:
  # Development viewer connecting to real UniSet2 on host
  # Usage: docker-compose --profile dev up dev-viewer
  dev-viewer:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - UNISET_URL=http://localhost:9090,http://localhost:9191,http://localhost:9292,http://localhost:9393,http://localhost:9494,http://localhost:9595
    command: >
      ./uniset2-viewer --addr :8000
      --uniset-url http://localhost:9090
      --uniset-url http://localhost:9191
      --uniset-url http://localhost:9292
      --uniset-url http://localhost:9393
      --uniset-url http://localhost:9494
      --uniset-url http://localhost:9595
    network_mode: host
    profiles:
      - dev

  # Mock uniset2 server for testing
  mock-uniset:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./tests/mock-server:/app
    command: node server.js
    expose:
      - "9393"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:9393/api/v2/list"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Our viewer server
  viewer:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - UNISET_URL=http://mock-uniset:9393
    command: ./uniset2-viewer --addr :8000 --uniset-url http://mock-uniset:9393 --confile /app/config/test.xml
    volumes:
      - ./config:/app/config:ro
    ports:
      - "8000:8000"
    depends_on:
      mock-uniset:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/objects"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Playwright tests
  e2e:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    working_dir: /app
    shm_size: 1g
    environment:
      - BASE_URL=http://viewer:8000
    volumes:
      - ./tests:/app:ro
      - ./tests/test-results:/app/test-results
      - ./tests/playwright-report:/app/playwright-report
    depends_on:
      viewer:
        condition: service_healthy
    entrypoint:
      - bash
      - -lc
      - |
        cd /tmp
        cp -r /app/* .
        npm install --no-fund --no-audit
        npx playwright test single/ --reporter=list
