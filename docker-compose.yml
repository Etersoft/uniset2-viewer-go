version: '3.8'

services:
  # Mock uniset2 server for testing
  mock-uniset:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./tests/mock-server:/app
    command: node server.js
    expose:
      - "9393"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:9393/api/v01/list"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Our viewer server
  viewer:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - UNISET_URL=http://mock-uniset:9393
    ports:
      - "8000:8000"
    depends_on:
      mock-uniset:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/objects"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Playwright tests
  e2e:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    working_dir: /app
    shm_size: 1g
    environment:
      - BASE_URL=http://viewer:8000
    volumes:
      - ./tests:/app:ro
      - ./tests/test-results:/app/test-results
      - ./tests/playwright-report:/app/playwright-report
    depends_on:
      viewer:
        condition: service_healthy
    entrypoint:
      - bash
      - -lc
      - |
        cd /tmp
        cp -r /app/* .
        npm install --no-fund --no-audit
        npx playwright test --reporter=list
