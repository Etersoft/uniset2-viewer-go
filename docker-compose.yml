services:
  # ClickHouse for journal testing
  # Starts automatically when needed via depends_on (viewer, dev-viewer)
  # Manual: docker compose up -d clickhouse
  # Data is stored in tmpfs - cleared on restart to ensure init scripts run
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    environment:
      - CLICKHOUSE_DB=uniset
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    tmpfs:
      - /var/lib/clickhouse
    volumes:
      - ./tests/clickhouse/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./tests/clickhouse/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
      - ./tests/clickhouse/dictionaries.xml:/etc/clickhouse-server/config.d/dictionaries.xml:ro
      - ./tests/clickhouse/dict-messages.csv:/docker-entrypoint-initdb.d/dict-messages.csv:ro
      - ./tests/clickhouse/init-check.sh:/init-check.sh:ro
    ports:
      - "9000:9000"
      - "8123:8123"
    healthcheck:
      test: ["CMD", "bash", "/init-check.sh"]
      interval: 2s
      timeout: 5s
      retries: 30

  # Development viewer connecting to real UniSet2 on host
  # Usage: docker-compose --profile dev up dev-viewer
  # Используйте -jsfile для горячей перезагрузки JS без пересборки контейнера
  dev-viewer:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - UNISET_URL=http://localhost:9090,http://localhost:9191,http://localhost:9292,http://localhost:9393,http://localhost:9494,http://localhost:9595
    command: >
      ./uniset-panel --addr :8000
      --log-level debug
      --uniset-config /app/config/test_noid.xml
      --uniset-url http://localhost:9090
      --uniset-url http://localhost:9191
      --uniset-url http://localhost:9292
      --uniset-url http://localhost:9393
      --uniset-url http://localhost:9494
      --uniset-url http://localhost:9595
      --uniset-url http://localhost:9696
      --uniset-url http://localhost:8081
      --control-timeout 60s
      --recording-path /tmp/recording.db
      --dashboards-dir /app/dashboards
      --journal-url "clickhouse://localhost:9000/uniset?name=DevJournal"
      --js /app/ext/app.js
      --css /app/ext/style.css
    volumes:
      - ./config:/app/config:ro
      - ./examples/dashboards:/app/dashboards:ro
      - ./ui/static/js/app.js:/app/ext/app.js:ro
      - ./ui/static/css/style.css:/app/ext/style.css:ro
    network_mode: host
    depends_on:
      clickhouse:
        condition: service_healthy
    profiles:
      - dev

  # Mock uniset2 server for testing
  mock-uniset:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./tests/mock-server:/app
    command: node server.js
    expose:
      - "9393"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:9393/api/v2/list"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Our viewer server
  viewer:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - UNISET_URL=http://mock-uniset:9393
    command: >
      ./uniset-panel --addr :8000
      --uniset-url http://mock-uniset:9393
      --uniset-config /app/config/test.xml
      --sm-url http://mock-uniset:9393
      --journal-url "clickhouse://clickhouse:9000/uniset?name=TestJournal"
      --js /app/ext/app.js
      --css /app/ext/style.css
    volumes:
      - ./config:/app/config:ro
      - ./ui/static/js/app.js:/app/ext/app.js:ro
      - ./ui/static/css/style.css:/app/ext/style.css:ro
    ports:
      - "8000:8000"
    depends_on:
      mock-uniset:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/objects"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Playwright tests
  e2e:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    working_dir: /app
    shm_size: 1g
    environment:
      - BASE_URL=http://viewer:8000
    volumes:
      - ./tests:/app:ro
      - ./tests/test-results:/app/test-results
      - ./tests/playwright-report:/app/playwright-report
    depends_on:
      viewer:
        condition: service_healthy
    entrypoint:
      - bash
      - -lc
      - |
        cd /tmp
        cp -r /app/* .
        npm install --no-fund --no-audit
        npx playwright test single/ --reporter=list

  # Demo mock server - Diesel Generator Simulator
  # Usage: docker-compose --profile demo up demo-viewer
  demo-mock-server:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./demo/mock-server:/app
    command: node server.js
    expose:
      - "9393"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:9393/api/v2/list"]
      interval: 2s
      timeout: 5s
      retries: 5
    profiles:
      - demo

  # Demo viewer connecting to demo mock server
  demo-viewer:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - UNISET_URL=http://demo-mock-server:9393
    command: >
      ./uniset-panel --addr :8000
      --uniset-url http://demo-mock-server:9393
      --sm-url http://demo-mock-server:9393
      --dashboards-dir /app/dashboards
      --js /app/ext/app.js
      --css /app/ext/style.css
    volumes:
      - ./config:/app/config:ro
      - ./examples/dashboards:/app/dashboards:ro
      - ./ui/static/js/app.js:/app/ext/app.js:ro
      - ./ui/static/css/style.css:/app/ext/style.css:ro
    ports:
      - "8001:8000"
    depends_on:
      demo-mock-server:
        condition: service_healthy
    profiles:
      - demo
